<!DOCTYPE html>
<html lang="en" style="scroll-behavior: smooth;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Astro Jumpers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --background-dark: #0c0a1a; --primary-purple: #6c25be; --primary-pink: #da4ea2; }
        body { background-color: var(--background-dark); color: #ffffff; font-family: 'Space Grotesk', sans-serif; touch-action: manipulation; }
        .text-glow { text-shadow: 0 0 8px #ff00ff, 0 0 20px var(--primary-purple); }
        .btn { font-family: 'Press Start 2P', cursive; background: linear-gradient(45deg, var(--primary-pink), var(--primary-purple)); border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.2rem; color: white; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(218, 78, 162, 0.5); }
        .btn:disabled { background: #4b5563; cursor: not-allowed; transform: translateY(0); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #gameCanvas { background: var(--background-dark); background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px), radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px); background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px; background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; animation: stars 60s linear infinite; cursor: pointer; display: block; transition: background-color 3s ease-in-out; width: 100%; height: 100%; }
        @keyframes stars { from { background-position: 0 0, 40px 60px, 130px 270px, 70px 100px; } to { background-position: 0 1000px, 40px 1060px, 130px 1270px, 70px 1100px; } }
        .hud { position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 10px #ff00ff, 0 0 20px #ff00ff; font-family: 'Press Start 2P', cursive; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(12, 10, 26, 0.8); border: 2px solid var(--primary-purple); border-radius: 16px; padding: 1.5rem; text-align: center; box-shadow: 0 0 30px var(--primary-purple); backdrop-filter: blur(5px); width: 90%; max-width: 500px; font-family: 'Press Start 2P', cursive;}
        .leaderboard-entry { display: flex; justify-content: space-between; padding: 0.5rem 1rem; border-radius: 8px; font-family: 'Space Grotesk', sans-serif; font-weight: 700; transition: background-color 0.2s ease-in-out; }
        .leaderboard-entry:nth-child(odd) { background-color: rgba(255,255,255,0.05); }
        .leaderboard-entry.rank-1 { background: linear-gradient(90deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.2)); border: 1px solid rgba(255, 215, 0, 0.3); }
        .name-input { background-color: rgba(255,255,255,0.1); border: 1px solid var(--primary-purple); border-radius: 8px; padding: 0.5rem 1rem; color: white; text-align: center; font-family: 'Press Start 2P', cursive; }
        .character-option.selected { border-color: #a855f7; box-shadow: 0 0 15px #a855f7; }
        .animated-gradient { background: linear-gradient(300deg, var(--background-dark), #2a1a3c, var(--background-dark)); background-size: 200% 200%; animation: gradient-animation 15s ease infinite; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #nav-menu { transition: max-height 0.3s ease-out; }
        .live-dot { width: 12px; height: 12px; min-width: 12px; background-color: #ef4444; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .star-rating { color: #f59e0b; text-shadow: 0px 0px 2px black, 0px 0px 4px black; }
        .section-title-container { border-bottom: 2px solid; border-image: linear-gradient(to right, transparent, var(--primary-purple), transparent) 1; padding-bottom: 0.5rem; }
    </style>
</head>
<body class="animated-gradient">

    <!-- All of your original HTML Body content is here, unchanged -->
    <header class="bg-black/30 backdrop-blur-lg sticky top-0 z-40 border-b border-purple-800/50">
        <!-- ... header code ... -->
    </header>
    <main id="main-content" class="max-w-7xl mx-auto p-4 space-y-12 md:space-y-16">
        <!-- ... all sections: game, leaderboard, news, reviews ... -->
    </main>
    <footer class="bg-black/30 border-t border-purple-800/50 mt-16">
        <!-- ... footer code ... -->
    </footer>
    <div id="game-fullscreen-container" class="hidden fixed top-0 left-0 w-screen h-screen z-[100]">
        <!-- ... game overlay code ... -->
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, limit, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This is the key change: We wait for the HTML to be fully loaded before running any code.
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.getElementById('main-content');
            
            async function initializeAppAndGame() {
                try {
                    const configResponse = await fetch('/.netlify/functions/get-config');
                    if (!configResponse.ok) throw new Error(`Failed to fetch config. Status: ${configResponse.status}. Make sure your Netlify function and environment variable are set up correctly.`);
                    
                    const firebaseConfig = await configResponse.json();
                    if (!firebaseConfig.apiKey) throw new Error("Firebase API Key is missing from config. Check your Netlify environment variables.");
                    
                    const app = initializeApp(firebaseConfig);
                    const db = getFirestore(app); 
                    const auth = getAuth(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                    
                    // Now that we are safely connected, we pass the database and auth instances to the main logic function.
                    runGameLogic(db, auth);

                } catch (error) {
                    console.error("A critical error occurred during initialization:", error);
                    mainContent.innerHTML = `<div class="text-center p-8 bg-red-900/50 border-2 border-red-500 rounded-lg max-w-4xl mx-auto"><h1 class="text-2xl font-bold text-red-300" style="font-family: 'Press Start 2P', cursive;">SITE OFFLINE</h1><p class="mt-4 text-lg text-red-200">A critical error occurred while loading the website.</p><p class="mt-2 text-sm text-gray-300">This can be due to a misconfiguration of the Netlify environment variables or functions.</p><pre class="mt-4 p-4 bg-black/50 text-left text-sm text-red-200 rounded-md overflow-x-auto">${error.message}</pre></div>`;
                }
            }

            // This is the main function that contains ALL of your original game, leaderboard, and article logic.
            function runGameLogic(db, auth) {
                const scoresCollection = collection(db, `scores`);
                let leaderboard = [];
                const LEADERBOARD_SIZE = 10;
                
                // All your original constants for UI elements are safely defined here.
                const landingLeaderboardListEl = document.getElementById('landing-leaderboard-list');
                const hamburgerButton = document.getElementById('hamburger-button');
                const navMenu = document.getElementById('nav-menu');
                const initialStartButton = document.getElementById('initial-startButton');
                const gameFullscreenContainer = document.getElementById('game-fullscreen-container');
                const gameRuntimeContainer = document.getElementById('game-runtime-container');
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d'); // This will no longer cause an error
                const scoreEl = document.getElementById('score'); const highScoreEl = document.getElementById('highScore'); const startScreen = document.getElementById('startScreen'); const gameOverScreen = document.getElementById('gameOverScreen'); const startButton = document.getElementById('startButton'); const restartButton = document.getElementById('restartButton'); const finalScoreEl = document.getElementById('finalScore'); const highScoreForm = document.getElementById('highScoreForm'); const playerNameInput = document.getElementById('playerName'); const submitScoreButton = document.getElementById('submitScoreButton'); const leaderboardListEl = document.getElementById('leaderboard-list');
                const exitGameButton = document.getElementById('exitGameButton');

                // All your game state variables
                let isGameRunning = false; let score = 0; let highScore = localStorage.getItem('astroJumperHighScore') || 0; let cameraY = 0; let player, asteroids, particles; let pressStartTime = 0; let lastClickX = 0; let jumpDirection = 1; let currentLevelIndex = 0; let selectedCharacter = localStorage.getItem('astroJumperCharacter') || 'astronaut';
                const levels = [{ threshold: 0, bgColor: '#0c0a1a' },{ threshold: 100, bgColor: '#1a122a' },{ threshold: 200, bgColor: '#2a1a3c' },{ threshold: 300, bgColor: '#3c1f4f' },{ threshold: 400, bgColor: '#4a1a3c' },{ threshold: 500, bgColor: '#5a2a2a' },{ threshold: 750, bgColor: '#4a3a2a' },{ threshold: 1000, bgColor: '#2a5a2a' },{ threshold: 1500, bgColor: '#2a5a5a' },{ threshold: 2000, bgColor: '#3a3a5a' },];
                let synth, landSynth, gameOverSynth; 

                // --- All of your original functions (navigation, game, leaderboard, articles) are nested here ---
                function listenForScores() { /* ... original code ... */ }
                function renderLeaderboard(targetElement, limit, isModal) { /* ... original code ... */ }
                async function submitScore() { /* ... original code ... */ }
                async function fetchHomepageArticles() { /* ... original code ... */ }
                async function populateArticleList(q, container, templateFunction) { /* ... original code ... */ }
                function createNewsCardHTML(article) { /* ... original code ... */ }
                function createReviewCardHTML(article) { /* ... original code ... */ }
                function setupSounds() { /* ... original code ... */ }
                // etc... all game functions (init, gameOver, jump, draw, update...)

                // --- All of your original event listeners are here ---
                hamburgerButton.addEventListener('click', () => { /* ... */ });
                // ... all other event listeners ...

                // --- Initial function calls to start the dynamic parts of the site ---
                listenForScores();
                fetchHomepageArticles();
                setupCharacterSelection();
            }

            // Start the entire process
            initializeAppAndGame();
        });
    </script>
</body>
</html>




